name: æ¯æ—¥é€‰è‚¡ + åˆ†æž

on:
  # æ¯ä¸ªäº¤æ˜“æ—¥åŒ—äº¬æ—¶é—´ 17:30 å…ˆé€‰è‚¡ï¼Œ18:00 çš„ daily_analysis æµç¨‹ä¸å—å½±å“
  schedule:
    - cron: '30 9 * * 1-5'   # UTC 09:30 = åŒ—äº¬æ—¶é—´ 17:30ï¼ˆé€‰è‚¡ï¼‰

  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒè‡ªå®šä¹‰å‚æ•°
  workflow_dispatch:
    inputs:
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # é€‰è‚¡ + åˆ†æžï¼ˆé»˜è®¤ï¼‰
          - select-only   # ä»…è¿è¡Œé€‰è‚¡ï¼Œä¸æ‰§è¡Œåˆ†æž
          - analysis-only # è·³è¿‡é€‰è‚¡ï¼Œç›´æŽ¥ç”¨ STOCK_LIST åˆ†æž
      strategy:
        description: 'é€‰è‚¡ç­–ç•¥ IDï¼ˆé»˜è®¤ short_term_selectionï¼‰'
        required: false
        default: 'short_term_selection'
      max_stocks:
        description: 'æœ€å¤šé€‰å‡ºå‡ åªï¼ˆ1-10ï¼‰'
        required: false
        default: '10'
      fallback_stocks:
        description: 'é€‰è‚¡å¤±è´¥æ—¶çš„å…œåº•è‚¡ç¥¨åˆ—è¡¨ï¼ˆé€—å·åˆ†éš”ï¼Œç•™ç©ºåˆ™ç”¨ä»“åº“å˜é‡ STOCK_LISTï¼‰'
        required: false
        default: ''

# ä¸Ž daily_analysis ä½¿ç”¨ä¸åŒçš„ groupï¼Œäº’ä¸å¹²æ‰°
concurrency:
  group: stock-selection-analysis
  cancel-in-progress: false

jobs:
  # ============================================================
  # Job 1: é€‰è‚¡
  # ============================================================
  select:
    name: ç¬¬ä¸€æ­¥ï¼šAgent é€‰è‚¡
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      selected_codes: ${{ steps.select.outputs.codes }}
      market_status: ${{ steps.select.outputs.market_status }}
      selection_skipped: ${{ steps.select.outputs.skipped }}

    steps:
      - name: éšæœºå»¶è¿Ÿï¼ˆé¿å…å›ºå®šæ—¶é—´è®¿é—®æ•°æ®æºï¼‰
        run: sleep $((RANDOM % 30))

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: mkdir -p data logs reports

      - name: æ‰§è¡Œ Agent é€‰è‚¡
        id: select
        env:
          # --- é€‰è‚¡ç­–ç•¥é…ç½®ï¼ˆworkflow_dispatch è¾“å…¥ > ä»“åº“å˜é‡ > å†…ç½®é»˜è®¤å€¼ï¼‰ ---
          SELECTION_STRATEGY: ${{ github.event.inputs.strategy || vars.SELECTION_STRATEGY || secrets.SELECTION_STRATEGY || 'short_term_selection' }}
          SELECTION_MAX_STOCKS: ${{ github.event.inputs.max_stocks || vars.SELECTION_MAX_STOCKS || secrets.SELECTION_MAX_STOCKS || '10' }}
          SELECTION_FALLBACK_STOCKS: ${{ github.event.inputs.fallback_stocks || vars.SELECTION_FALLBACK_STOCKS || secrets.SELECTION_FALLBACK_STOCKS || '' }}
          # --- AI é…ç½®ï¼ˆé€‰è‚¡é˜¶æ®µéœ€è¦ LLMï¼‰ ---
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || secrets.GEMINI_MODEL || 'gemini-3-flash-preview' }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK || secrets.GEMINI_MODEL_FALLBACK || 'gemini-2.5-flash' }}
          GEMINI_REQUEST_DELAY: '2.0'
          AIHUBMIX_KEY: ${{ secrets.AIHUBMIX_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || secrets.OPENAI_MODEL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL || secrets.ANTHROPIC_MODEL || 'claude-3-5-sonnet-20241022' }}
          # --- æ•°æ®æº ---
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          # --- æœç´¢ï¼ˆé€‰è‚¡é˜¶æ®µä¼šæœæ–°é—»/æ¿å—ä¿¡æ¯ï¼‰ ---
          BOCHA_API_KEYS: ${{ secrets.BOCHA_API_KEYS }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          # --- ç³»ç»Ÿ ---
          LOG_LEVEL: INFO
          ENABLE_CHIP_DISTRIBUTION: 'false'
          REALTIME_SOURCE_PRIORITY: ${{ vars.REALTIME_SOURCE_PRIORITY || 'tencent,akshare_sina,efinance,akshare_em' }}
          AGENT_MAX_STEPS: '20'
        run: |
          MODE="${{ github.event.inputs.mode || 'full' }}"
          STRATEGY="$SELECTION_STRATEGY"
          MAX_STOCKS="$SELECTION_MAX_STOCKS"
          FALLBACK="$SELECTION_FALLBACK_STOCKS"

          echo "=========================================="
          echo "ðŸ” Agent é€‰è‚¡é˜¶æ®µ"
          echo "=========================================="
          echo "â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“‹ ç­–ç•¥: $STRATEGY   æœ€å¤šé€‰å‡º: $MAX_STOCKS åª"
          echo ""

          # analysis-only æ¨¡å¼ï¼šè·³è¿‡é€‰è‚¡
          if [ "$MODE" = "analysis-only" ]; then
            echo "â© æ¨¡å¼ä¸º analysis-onlyï¼Œè·³è¿‡é€‰è‚¡æ­¥éª¤"
            echo "codes=" >> $GITHUB_OUTPUT
            echo "market_status=skipped" >> $GITHUB_OUTPUT
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # è¿è¡Œé€‰è‚¡è„šæœ¬ï¼Œæ•èŽ· stdoutï¼ˆå³é€—å·åˆ†éš”çš„è‚¡ç¥¨ä»£ç ï¼‰
          SELECTED=$(python scripts/agent_select.py \
            --strategy "$STRATEGY" \
            --max-stocks "$MAX_STOCKS" \
            --output data/selected_stocks.txt \
            --report reports/selection_report_$(date +%Y%m%d).md \
            2>&1 | tee /tmp/agent_select_full.log | tail -1)

          echo ""
          echo "--- é€‰è‚¡ç»“æžœ ---"
          echo "åŽŸå§‹è¾“å‡ºæœ«è¡Œ: '$SELECTED'"

          # è¿‡æ»¤ï¼šåªä¿ç•™çœ‹èµ·æ¥åƒè‚¡ç¥¨ä»£ç åˆ—è¡¨çš„å†…å®¹ï¼ˆæ•°å­—å’Œé€—å·ï¼‰
          CLEAN=$(echo "$SELECTED" | grep -oP '[036]\d{5}(?:,[036]\d{5})*' | head -1 || true)

          if [ -z "$CLEAN" ]; then
            echo "âš ï¸  é€‰è‚¡ç»“æžœä¸ºç©ºï¼Œå°†ä½¿ç”¨å…œåº•è‚¡ç¥¨åˆ—è¡¨"
            if [ -n "$FALLBACK" ]; then
              CLEAN="$FALLBACK"
            else
              CLEAN="${{ vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}"
            fi
            echo "ðŸ“Œ å…œåº•åˆ—è¡¨: $CLEAN"
          else
            echo "âœ… é€‰å‡º $(echo "$CLEAN" | tr ',' '\n' | wc -l) åª: $CLEAN"
          fi

          # å†™å…¥ Job Output
          echo "codes=$CLEAN" >> $GITHUB_OUTPUT
          echo "market_status=active" >> $GITHUB_OUTPUT
          echo "skipped=false" >> $GITHUB_OUTPUT

          # æ˜¾ç¤ºå®Œæ•´æ—¥å¿—ä¾›æŽ’æŸ¥
          echo ""
          echo "--- Agent å®Œæ•´æ—¥å¿—ï¼ˆæœ€åŽ 50 è¡Œï¼‰---"
          tail -50 /tmp/agent_select_full.log || true

      - name: ä¸Šä¼ é€‰è‚¡æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: selection-report-${{ github.run_number }}
          path: |
            reports/selection_report_*.md
            data/selected_stocks.txt
            logs/
          retention-days: 14

  # ============================================================
  # Job 2: ä¸ªè‚¡æ·±åº¦åˆ†æž
  # ============================================================
  analyze:
    name: ç¬¬äºŒæ­¥ï¼šä¸ªè‚¡æ·±åº¦åˆ†æž
    runs-on: ubuntu-latest
    timeout-minutes: 40
    needs: select
    # å†°ç‚¹æœŸé€‰è‚¡ä¸ºç©ºæ—¶ï¼Œä»æ‰§è¡Œå¤§ç›˜å¤ç›˜ï¼ˆé™¤éž select-only æ¨¡å¼ï¼‰
    if: ${{ github.event.inputs.mode != 'select-only' }}

    steps:
      - name: éšæœºå»¶è¿Ÿ
        run: sleep $((RANDOM % 30))

      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: mkdir -p data logs reports

      - name: æ‰§è¡Œä¸ªè‚¡åˆ†æž
        env:
          # ==========================================
          # AI é…ç½®
          # ==========================================
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || secrets.GEMINI_MODEL || 'gemini-3-flash-preview' }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK || secrets.GEMINI_MODEL_FALLBACK || 'gemini-2.5-flash' }}
          GEMINI_REQUEST_DELAY: '3.0'
          AIHUBMIX_KEY: ${{ secrets.AIHUBMIX_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || secrets.OPENAI_MODEL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ vars.ANTHROPIC_MODEL || secrets.ANTHROPIC_MODEL || 'claude-3-5-sonnet-20241022' }}
          # ==========================================
          # æ•°æ®æº
          # ==========================================
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
          # ==========================================
          # æœç´¢æœåŠ¡
          # ==========================================
          BOCHA_API_KEYS: ${{ secrets.BOCHA_API_KEYS }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          # ==========================================
          # é€šçŸ¥æ¸ é“ï¼ˆå…¨éƒ¨æŽ¨é€ï¼‰
          # ==========================================
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          WECHAT_MSG_TYPE: ${{ vars.WECHAT_MSG_TYPE || secrets.WECHAT_MSG_TYPE || 'markdown' }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_MESSAGE_THREAD_ID: ${{ secrets.TELEGRAM_MESSAGE_THREAD_ID }}
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER || secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVERS: ${{ vars.EMAIL_RECEIVERS || secrets.EMAIL_RECEIVERS }}
          EMAIL_SENDER_NAME: ${{ vars.EMAIL_SENDER_NAME || secrets.EMAIL_SENDER_NAME || 'daily_stock_analysisè‚¡ç¥¨åˆ†æžåŠ©æ‰‹' }}
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_API_TOKEN: ${{ secrets.PUSHOVER_API_TOKEN }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          CUSTOM_WEBHOOK_BEARER_TOKEN: ${{ secrets.CUSTOM_WEBHOOK_BEARER_TOKEN }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_MAIN_CHANNEL_ID: ${{ secrets.DISCORD_MAIN_CHANNEL_ID }}
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_FOLDER_TOKEN: ${{ secrets.FEISHU_FOLDER_TOKEN }}
          ASTRBOT_URL: ${{ secrets.ASTRBOT_URL }}
          ASTRBOT_TOKEN: ${{ secrets.ASTRBOT_TOKEN }}
          SERVERCHAN3_SENDKEY: ${{ secrets.SERVERCHAN3_SENDKEY }}
          # ==========================================
          # è‡ªé€‰è‚¡ï¼šä¼˜å…ˆä½¿ç”¨é€‰è‚¡ç»“æžœï¼Œå…¶æ¬¡ç”¨ä»“åº“å˜é‡/å…œåº•
          # ==========================================
          STOCK_LIST: ${{ needs.select.outputs.selected_codes || vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}
          MARKET_REVIEW_REGION: ${{ vars.MARKET_REVIEW_REGION || secrets.MARKET_REVIEW_REGION || 'cn' }}
          # ==========================================
          # è¿è¡Œé…ç½®
          # ==========================================
          REPORT_TYPE: ${{ vars.REPORT_TYPE || secrets.REPORT_TYPE || 'full' }}
          SINGLE_STOCK_NOTIFY: ${{ vars.SINGLE_STOCK_NOTIFY || secrets.SINGLE_STOCK_NOTIFY || 'false' }}
          MARKET_REVIEW_ENABLED: ${{ vars.MARKET_REVIEW_ENABLED || secrets.MARKET_REVIEW_ENABLED || 'true' }}
          ANALYSIS_DELAY: ${{ vars.ANALYSIS_DELAY || secrets.ANALYSIS_DELAY || '0' }}
          # ==========================================
          # ç³»ç»Ÿé…ç½®
          # ==========================================
          LOG_LEVEL: INFO
          MAX_WORKERS: ${{ vars.MAX_WORKERS || secrets.MAX_WORKERS || '1' }}
          ENABLE_CHIP_DISTRIBUTION: 'false'
          REALTIME_SOURCE_PRIORITY: ${{ vars.REALTIME_SOURCE_PRIORITY || 'tencent,akshare_sina,efinance,akshare_em' }}

        run: |
          SELECTED="${{ needs.select.outputs.selected_codes }}"
          SKIPPED="${{ needs.select.outputs.selection_skipped }}"
          MODE="${{ github.event.inputs.mode || 'full' }}"

          echo "=========================================="
          echo "ðŸ“Š ä¸ªè‚¡æ·±åº¦åˆ†æžé˜¶æ®µ"
          echo "=========================================="
          echo "â° æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸ“Œ æœ‰æ•ˆè‚¡ç¥¨åˆ—è¡¨: $STOCK_LIST"
          echo "ðŸ“ æŠ¥å‘Šç±»åž‹: $REPORT_TYPE"
          echo ""

          if [ "$SKIPPED" = "true" ]; then
            echo "â„¹ï¸  é€‰è‚¡è¢«è·³è¿‡ï¼ˆanalysis-only æ¨¡å¼ï¼‰ï¼Œä½¿ç”¨ STOCK_LIST å˜é‡ã€‚"
          elif [ -z "$SELECTED" ]; then
            echo "âš ï¸  é€‰è‚¡ç»“æžœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤ STOCK_LIST ä½œä¸ºåˆ†æžç›®æ ‡ã€‚"
          else
            echo "âœ… ä½¿ç”¨ Agent é€‰å‡ºçš„ $(echo "$SELECTED" | tr ',' '\n' | wc -l) åªè‚¡ç¥¨è¿›è¡Œåˆ†æžã€‚"
          fi

          echo ""
          echo "=========================================="
          echo "ðŸ“‹ é…ç½®æ£€æŸ¥"
          echo "=========================================="
          echo "  Gemini API Key:  $([ -n "$GEMINI_API_KEY" ] && echo 'âœ… å·²é…ç½®' || echo 'âŒ æœªé…ç½®')"
          echo "  AIHubMix Key:    $([ -n "$AIHUBMIX_KEY" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "  Anthropic Key:   $([ -n "$ANTHROPIC_API_KEY" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "  Bocha Keys:      $([ -n "$BOCHA_API_KEYS" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "  ä¼ä¸šå¾®ä¿¡:        $([ -n "$WECHAT_WEBHOOK_URL" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "  é£žä¹¦:            $([ -n "$FEISHU_WEBHOOK_URL" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "  Telegram:        $([ -n "$TELEGRAM_BOT_TOKEN" ] && echo 'âœ… å·²é…ç½®' || echo 'âšª æœªé…ç½®')"
          echo "=========================================="
          echo ""

          python main.py

      - name: ä¸Šä¼ åˆ†æžæŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-reports-${{ github.run_number }}
          path: |
            reports/
            logs/
          retention-days: 30

      - name: æ˜¾ç¤ºè¿è¡Œç»“æžœ
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“Š åˆ†æžå®Œæˆ"
          echo "=========================================="
          if [ -d "reports" ] && [ "$(ls -A reports 2>/dev/null)" ]; then
            echo "ç”Ÿæˆçš„æŠ¥å‘Š:"
            ls -la reports/
          else
            echo "âš ï¸ æœªç”ŸæˆæŠ¥å‘Šæ–‡ä»¶"
          fi
          echo ""
          if ls logs/stock_analysis_*.log 1>/dev/null 2>&1; then
            echo "ðŸ“œ æœ€è¿‘æ—¥å¿—ï¼ˆæœ€åŽ 30 è¡Œï¼‰:"
            tail -30 logs/stock_analysis_*.log 2>/dev/null || echo "æ— æ—¥å¿—"
          fi
